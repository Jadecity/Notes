##safeLanding的检测方法

1. 声纳高度: 如果声纳高度在(0.22, 0.95)之间，就认为安全，直接降落。
  这也就意味着，在此区间的视觉是没有起作用的。那么为什么设定这个范围呢？答：0.22是飞控给出的，0.7是视觉盲区阈值，为了给一个缓冲区，设定为0.95.

  分析：
  1米以外视觉工作，靠视觉检测“不安全情况。
  (0.22, 0.95)之间，（0.7，0.9）米之间视差图开始出现显著错误，所以视觉不工作，全靠声纳，**也就是无法对障碍物进行判断**。
  0.22米以内声纳不工作，视觉重新开始工作，但此时视差图完全是黑的，也就是无法构造点云，直接在dangerous点判断时就退出了，因此0.22米之内，无法判断地面情况。

2. 计算点云和危险点云个数。
	2.1. 如果危险点云个数小于15, 退出算法； ？？？这里阈值是怎么来的？？？
	2.2. 否则比较总点云个数，如果小于2000，则认为不确定，退出算法。？？？这里阈值是怎么来的？？？

	计算视差
		1. 为什么disp_img像素要除16?
		2. Z的检测范围是4米
		3. X，Y的检测范围都是0.75米
		4. Z 在2米内的且X，Y小于0.5米内的，为危险点、
		5. 检测范围内的，X，Y都在0.4米内的认为是point_landing_area。
		6. 总点云个数为检测范围内所有点云个数。
分析：
	1. 危险点云个数是经验值，设成15可能确实把少数噪音滤掉了，但其实是这个条件没太大作用。

3. 用RANSAC拟合平面，得到平面的a,b,c三个参数；然后计算平面法向量与飞机姿态Z轴单位向量的內积，得到平面倾斜夹角theta。
	如果theta > 25 degree，也就是內积小于0.90，就认为平面倾斜过大，不安全。
分析：这个条件基本没有问题，但是数据发现获得的点云质量不好，水平静止状态拟合出来的平面也有10度到20度的倾斜，可能导致误报。

4. 计算下一帧图像和上一帧图像的局部patch的相关性，用于检测高度动态的物体，比如风中的草。
  4.1. 1.2米高度以内，认为完全相关（高度低，图像较稳定）；
  4.2. 从前一帧图像中间扣120x120的图像
  4.3. 获取新图像中间60x60的图像
  4.4. 根据两帧高度差设置缩放因子，delta 在[0.8, 1.2]
  4.5. 调用精准降落模块的函数，计算相关性。
  4.6. 如果相关性小于0.7,认为不安全（地面过于动态）。！！！注意在退出前更新previous_left_image。
  分析：主要目的是为了检测高动态表面，比如风吹动状态的草地。
  问题： 
  1. 但这种状态的草地理论上可以降落啊，为什么不让降落呢？
  2. 计算相关性的时候，是否考虑了飞机水平旋转后的图像？
  3. 什么时候会稳定出现低相关性的报警呢？
  4. 计算point_landing_area内，位于“空中”的点的比率r，如果r > 2%,则认为不安全。
    **注意**：计算deviation的函数内计算距离平方的代码并没有用（variance_p_std没用）。
     分析：
     	2米内，光心距离的1%+4cm，也就是最多6cm，认为是“空中”阈值。
     	2米外，光心距离的10%-14cm，认为是“空中”阈值。
           也就是平面拟合时，波动区域不能大于2%。
     问题: 按比率的方式，并不能很好表征拟合平面两侧的平整性，尤其对于平面上直接立起一个细柱的情形，容易漏检。另一种容易漏的情形是折线形的表面。

6. 如果开启了高曝光像素比率检测标志，则执行高曝光检测：大于250的像素认为是高曝光，高曝光率r > 20%认为是不安全。
分析：夏季沙滩或广场，阳光直射，不知是否会产生高曝光的情况。

7. 检测降落区域边界与点云重合的情况，这是为了检测到降落到平面物体边缘的情况。
	7.1. 分别计算landing area上、下、左、右四个边界一侧点云个数
	7.2. 如果都满足数量（至少15个）条件，则认为检查通过，返回1;否则返回0。
	7.3. 如果返回是0,则认为不安全。
分析：这里漏了一种情况，就是恰巧在平面边缘，点云是有的，而且能正常拟合出一个平面，只是脚不能完全落在平面上。

8. 最后再把之前计算过的视觉高度和安全高度（0.95米）比较，小于安全高度，则认为是安全，可以SAFE_LAND.

**可能的优化**
1. 降落在手上。
	优点：
	1. 增加和用户的互动
	2. 在不适合降落的区域正常降落
	缺点：
	1. 有一定危险性
	2. 手部不容易识别定位
	3. 伸手时间长容易累，必须控制降落时间
2. 自动寻找可降落区域
	优点：
	1. 可在低电情况下安全降落
	2. 对初学者更容易
	3. 普通降落更加安全
	缺点：
	1. 如果选择的位置不够正确，可能带来功能不好的印象
	2. 难度较高，需要对高清图像进行分析和识别，并且需要结合近距离的3D数据。


